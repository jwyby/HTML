<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¿å®¢å°ç­æŠ¥</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            // CRITICAL: Disable preflight to prevent resetting your blog's global styles (headers, borders, etc.)
            corePlugins: {
                preflight: false,
            },
            theme: {
                extend: {
                    colors: {
                        'theme-blue': '#425AEF',
                        'text-main': '#1f2937',
                        'text-sub': '#4b5563',
                    },
                    fontFamily: {
                        sans: ['"PingFang SC"', '"Hiragino Sans GB"', '"Microsoft YaHei"', 'sans-serif'],
                        num: ['"DIN Alternate"', '"Roboto"', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 8px 16px -4px rgba(44, 45, 48, 0.05)',
                    },
                    animation: {
                        'wave': 'wave 2.5s infinite',
                        'radar': 'radar 2s linear infinite',
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '10%, 30%': { transform: 'rotate(14deg)' },
                            '20%': { transform: 'rotate(-8deg)' },
                            '40%': { transform: 'rotate(-4deg)' },
                            '50%, 60%': { transform: 'rotate(10deg)' },
                        },
                        radar: {
                            '0%': { transform: 'scale(0.8)', opacity: '0.5' },
                            '100%': { transform: 'scale(2.5)', opacity: '0' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Scoped styles to ensure the card looks right without affecting the whole page */
        #visitor-card-container {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            box-sizing: border-box;
            line-height: 1.5;
        }
        #visitor-card-container * {
            box-sizing: border-box;
        }
        .emoji-anim { display: inline-block; transform-origin: 70% 70%; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>
</head>
<body style="margin: 0; padding: 0; background: transparent;">

    <!-- 
      Main Container 
      - w-full: Fills the sidebar width
      - h-auto: Height grows with content (fixes the "can't see text" issue)
      - No 'h-full' on body prevents scroll locking
    -->
    <div id="visitor-card-container" class="w-full h-auto p-2">
        
        <div class="w-full min-h-[180px] bg-white rounded-2xl p-4 shadow-card border border-gray-100 relative overflow-hidden flex flex-col justify-center items-center group transition-all duration-300 hover:shadow-lg hover:border-theme-blue/30">
            
            <!-- Loading State: Radar Animation -->
            <div id="loading-state" class="flex flex-col items-center justify-center w-full py-6 space-y-4">
                <div class="relative flex items-center justify-center">
                    <!-- Radar Ripples -->
                    <div class="absolute w-8 h-8 bg-theme-blue rounded-full opacity-20 animate-radar"></div>
                    <div class="absolute w-8 h-8 bg-theme-blue rounded-full opacity-20 animate-radar" style="animation-delay: 1s;"></div>
                    <!-- Icon -->
                    <i class="fa-solid fa-satellite-dish text-theme-blue text-xl z-10 relative"></i>
                </div>
                <p id="loading-text" class="text-xs text-gray-400 tracking-wide">å«æ˜Ÿå®šä½ä¸­...</p>
            </div>

            <!-- Success Content -->
            <div id="success-state" class="hidden w-full flex flex-col items-center justify-between animate-fade-in select-none">
                
                <!-- Top Section: Welcome -->
                <div class="flex flex-col items-center w-full mb-3">
                    <div class="text-text-sub text-xs opacity-70 flex items-center gap-1 mb-1">
                        æ¬¢è¿æ¥è‡ª <span class="emoji-anim animate-wave">ğŸ‘‹</span>
                    </div>

                    <!-- Location: Allows full wrapping for long names -->
                    <div class="w-full px-1 flex justify-center">
                        <div id="user-location" class="text-[1.1rem] leading-tight font-bold text-text-main text-center break-words whitespace-normal">
                            <!-- Location text will go here -->
                        </div>
                    </div>

                    <!-- Dialect Badge -->
                    <div id="dialect-badge" class="hidden mt-2 text-xs bg-blue-50 text-theme-blue px-2 py-0.5 rounded-full font-medium transform transition-transform hover:scale-105 cursor-default border border-blue-100">
                        <!-- Dialect text will go here -->
                    </div>
                </div>

                <!-- Middle Section: Distance & IP -->
                <div class="w-full flex flex-col items-center justify-center mb-3 space-y-1">
                    <div class="text-text-sub text-xs">
                        è·åšä¸»çº¦ <span id="distance-val" class="text-theme-blue font-bold font-num text-lg mx-0.5">0</span> km
                    </div>
                    
                    <!-- IP Display -->
                    <div class="group/ip relative cursor-pointer">
                        <div class="text-[10px] text-gray-400 bg-gray-50 px-2 py-0.5 rounded border border-gray-100 font-num transition-colors group-hover/ip:bg-blue-50 group-hover/ip:text-theme-blue">
                            IP: <span id="user-ip">...</span>
                        </div>
                    </div>
                </div>

                <!-- Footer: Time Greeting -->
                <div class="w-full pt-3 border-t border-dashed border-gray-100 flex items-center justify-center gap-1.5 text-text-sub text-[11px] opacity-90">
                    <span id="weather-icon"></span>
                    <span id="time-greeting"></span>
                </div>

            </div>

            <!-- Error State (Fallback) -->
            <div id="error-state" class="hidden w-full flex flex-col items-center justify-center animate-fade-in text-center p-4">
                <div class="text-3xl mb-2 grayscale opacity-50">ğŸŒ</div>
                <h3 class="text-gray-600 font-bold text-sm mb-1">å®šä½è¶…æ—¶</h3>
                <button onclick="initVisitorCard()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full transition-colors mt-2">
                    é‡è¯•
                </button>
            </div>

        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const CONFIG = {
            ownerLat: 39.9042, // åšä¸»ä½ç½® (åŒ—äº¬)
            ownerLon: 116.4074,
            timeout: 2000 // å•ä¸ªæ¥å£è¶…æ—¶æ—¶é—´
        };

        // ================= æ–¹è¨€å­—å…¸ =================
        const GREETINGS = {
            "å¹¿ä¸œ": "é›·çŒ´å•Šï¼é¥®èŒ¶æœªï¼ŸğŸµ",
            "é¦™æ¸¯": "é›·çŒ´å•Šï¼å¥½è€å†‡è§ï¼ğŸ‘‹",
            "å¹¿è¥¿": "è¡¨å“¥/è¡¨å¦¹ï¼Œæ¥ç¢—ç²‰å‘—ï¼ğŸœ",
            "ç¦å»º": "å‘·é¥±æœªï¼Ÿæ¥å–èŒ¶ï¼ğŸµ",
            "å¦é—¨": "å‘·é¥±æœªï¼Ÿæ¥å–èŒ¶ï¼ğŸµ",
            "å››å·": "è€æœ‹å‹æ²¡å¾—ï¼Ÿåƒç«é”…å»ï¼ğŸŒ¶ï¸",
            "é‡åº†": "å‹’æ˜¯é›¾éƒ½ï¼åƒç«é”…ä¸ï¼ŸğŸŒ¶ï¸",
            "æ¹–å—": "åƒåœ†ç²‰è¿˜æ˜¯æ‰ç²‰ï¼ŸğŸœ",
            "æ¹–åŒ—": "è¿‡æ—©äº†å—ï¼Ÿçƒ­å¹²é¢æ•´èµ·ï¼ğŸœ",
            "ä¸œåŒ—": "è€é“æ¥å•¦ï¼æ•´ä¸¤å£ï¼ŸğŸº",
            "è¾½å®": "è€é“æ¥å•¦ï¼æ•´ä¸¤å£ï¼ŸğŸº",
            "é»‘é¾™æ±Ÿ": "å“å‘€å¦ˆå‘€ï¼Œè´¼æ‹‰æ¬¢è¿ï¼â„ï¸",
            "å‰æ—": "è€é“æ¥å•¦ï¼ğŸº",
            "åŒ—äº¬": "åƒäº†å—æ‚¨å†…ï¼ŸğŸ¥¢",
            "å¤©æ´¥": "ç»“ç•Œï¼Œåƒäº†å—æ‚¨å†…ï¼ŸğŸ¥",
            "ä¸Šæµ·": "ä¾¬å¥½ï¼æ¬¢è¿æ¥ç™½ç›¸ï¼ğŸ™ï¸",
            "æ±Ÿè‹": "æ•£è£…å¤§çœæ¬¢è¿ä½ ï¼ğŸ¦¢",
            "æµ™æ±Ÿ": "è€æ¿ï¼Œå‘è´¢å‘è´¢ï¼ğŸ’°",
            "å±±ä¸œ": "æµ©å…‹å±±ä¸œæ¬¢è¿æ‚¨ï¼ğŸ”ï¸",
            "é™•è¥¿": "å˜¹å’‹å’§ï¼è‚‰å¤¹é¦æ•´èµ·ï¼ğŸ¥™",
            "æ²³å—": "ä¸­ï¼çœŸä¸­ï¼ğŸ¯",
            "å°æ¹¾": "æ¬¢è¿ä½ ï¼æ¥å–æ¯çå¥¶ï¼ğŸ§‹",
            "å›½å¤–": "Hello Friend! Welcome! ğŸŒ"
        };

        // ================= å·¥å…·å‡½æ•° =================
        function getDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return 0;
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function getTimeGreeting() {
            const h = new Date().getHours();
            if(h<5) return {t:"å¤œæ·±äº†ï¼Œæ³¨æ„ä¼‘æ¯", i:"ğŸ˜´"};
            if(h<9) return {t:"æ—©ä¸Šå¥½ï¼Œå…ƒæ°”æ»¡æ»¡", i:"ğŸŒ…"};
            if(h<12) return {t:"ä¸Šåˆå¥½ï¼Œå·¥ä½œåŠ æ²¹", i:"ğŸ’ª"};
            if(h<14) return {t:"å¹²é¥­äººï¼Œåˆé¥­åƒå•¥", i:"ğŸš"};
            if(h<18) return {t:"ä¸‹åˆå¥½ï¼Œå–æ¯èŒ¶å§", i:"ğŸµ"};
            if(h<22) return {t:"æ™šä¸Šå¥½ï¼Œæ”¾æ¾ä¸€ä¸‹", i:"ğŸŒ™"};
            return {t:"å¾ˆæ™šäº†ï¼Œæ—©ç‚¹ç¡å“¦", i:"ğŸ›Œ"};
        }

        function getRegionalGreeting(locationStr) {
            for (const [key, value] of Object.entries(GREETINGS)) {
                if (locationStr.includes(key)) return value;
            }
            if (!locationStr.includes("ä¸­å›½")) return GREETINGS["å›½å¤–"];
            return "å¾ˆé«˜å…´é‡è§ä½ ï¼âœ¨";
        }

        // ================= ä¸»é€»è¾‘ =================

        const els = {
            loading: document.getElementById('loading-state'),
            success: document.getElementById('success-state'),
            error: document.getElementById('error-state'),
            loc: document.getElementById('user-location'),
            ip: document.getElementById('user-ip'),
            dist: document.getElementById('distance-val'),
            time: document.getElementById('time-greeting'),
            icon: document.getElementById('weather-icon'),
            badge: document.getElementById('dialect-badge')
        };

        function show(state) {
            ['loading', 'success', 'error'].forEach(k => els[k].classList.add('hidden'));
            els[state].classList.remove('hidden');
        }

        async function fetchWithTimeout(url) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), CONFIG.timeout);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                if(!response.ok) throw new Error("HTTP error");
                return await response.json();
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        async function initVisitorCard() {
            show('loading');
            
            let finalData = {
                ip: "127.0.0.1",
                location: "ç½‘ç»œæ¼«æ¸¸è€…",
                rawLoc: "æœªçŸ¥",
                lat: null,
                lon: null
            };
            let success = false;

            // 1. IPWho.is
            try {
                if(!success) {
                    const data = await fetchWithTimeout('https://ipwho.is/?lang=zh-CN');
                    if(data.success) {
                        finalData = {
                            ip: data.ip,
                            location: data.country === 'ä¸­å›½' ? (data.region === data.city ? data.city : `${data.region} ${data.city}`) : `${data.country} ${data.city}`,
                            rawLoc: (data.region || '') + (data.city || ''),
                            lat: data.latitude,
                            lon: data.longitude
                        };
                        success = true;
                    }
                }
            } catch(e) { console.log("Primary API skipped"); }

            // 2. Uomg
            try {
                if(!success) {
                    const data = await fetchWithTimeout('https://api.uomg.com/api/visitor.info?s=json');
                    if(data.code === 1) {
                        finalData = {
                            ip: data.ip,
                            location: data.location,
                            rawLoc: data.location,
                            lat: null,
                            lon: null
                        };
                        success = true;
                    }
                }
            } catch(e) { console.log("Secondary API skipped"); }

            try {
                els.loc.innerText = finalData.location;
                els.ip.innerText = finalData.ip;
                
                const dialect = getRegionalGreeting(finalData.rawLoc);
                if (dialect) {
                    els.badge.innerText = dialect;
                    els.badge.classList.remove('hidden');
                } else {
                    els.badge.classList.add('hidden');
                }

                if (finalData.lat) {
                    const dist = getDistance(CONFIG.ownerLat, CONFIG.ownerLon, finalData.lat, finalData.lon);
                    els.dist.innerText = dist;
                } else {
                    els.dist.innerText = "???";
                }

                const g = getTimeGreeting();
                els.time.innerText = g.t;
                els.icon.innerText = g.i;

                show('success');

            } catch (e) {
                console.error(e);
                show('error');
            }
        }

        setTimeout(initVisitorCard, 100);

    </script>
</body>
</html>